<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test Data Mapping</title>
</head>
<body>
    <h1>Test Results</h1>
    <pre id="output"></pre>
    
    <script src="lib/xlsx.full.min.js"></script>
    <script type="module">
        import { DataParser } from './js/modules/dataParser.js';
        import { DataValidator } from './js/modules/dataValidator.js';
        
        const output = document.getElementById('output');
        
        async function test() {
            try {
                output.textContent += 'Loading Excel file...\n';
                
                // Fetch the example file
                const response = await fetch('./examples/10月份维修数据.xlsx');
                const arrayBuffer = await response.arrayBuffer();
                
                output.textContent += 'Parsing Excel...\n';
                
                const parser = new DataParser();
                const result = parser.parseExcel(arrayBuffer);
                
                if (!result.success) {
                    output.textContent += 'Parse failed: ' + result.error + '\n';
                    return;
                }
                
                output.textContent += 'Parse succeeded!\n';
                output.textContent += 'Rows: ' + result.rowCount + '\n';
                output.textContent += 'Headers: ' + JSON.stringify(result.headers) + '\n\n';
                output.textContent += 'Column Mapping: ' + JSON.stringify(result.columnMapping, null, 2) + '\n\n';
                
                // Check first data row
                if (result.data.length > 0) {
                    const firstRow = result.data[0];
                    output.textContent += 'First row keys: ' + JSON.stringify(Object.keys(firstRow).slice(0, 6)) + '\n\n';
                    output.textContent += 'First row sample:\n';
                    output.textContent += '  工单号: ' + firstRow['工单号'] + '\n';
                    output.textContent += '  车间: ' + firstRow['车间'] + '\n';
                    output.textContent += '  维修人: ' + firstRow['维修人'] + '\n\n';
                    
                    // Now test the validator
                    output.textContent += 'Testing validator...\n';
                    const validator = new DataValidator();
                    const validationResult = validator.validate(result.data, result.columnMapping);
                    
                    output.textContent += 'Validation result: ' + JSON.stringify(validationResult, null, 2) + '\n';
                }
                
            } catch (error) {
                output.textContent += 'Error: ' + error.message + '\n';
                output.textContent += error.stack + '\n';
            }
        }
        
        test();
    </script>
</body>
</html>
