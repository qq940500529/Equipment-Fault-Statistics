# 架构设计

本文档详细介绍设备故障统计系统的整体架构设计、技术选型和模块划分。

## 系统概述

设备故障统计系统是一个**纯前端**的数据处理与可视化平台，具有以下特点：

- 🌐 **零部署**: 纯静态HTML/CSS/JavaScript，可直接在浏览器中运行
- 📴 **离线运行**: 所有处理均在客户端完成，无需网络连接
- 🔒 **数据安全**: 数据不上传到服务器，完全本地处理
- 🖥️ **跨平台**: 支持Windows、macOS、Linux等操作系统

## 技术架构

### 技术栈

#### 核心技术
- **前端框架**: 原生JavaScript (ES6+)
  - 零依赖，最轻量
  - 直接浏览器运行
  - 完全离线可用

#### 关键库
- **Excel处理**: [SheetJS](https://sheetjs.com/) (xlsx) v0.20.2
  - 纯JavaScript实现
  - 读取和写入Excel文件
  - 支持 .xlsx 和 .xls 格式

- **图表库**: [Apache ECharts](https://echarts.apache.org/) v5.x
  - 功能强大的可视化库
  - 丰富的图表类型
  - 优秀的中文支持

- **日期处理**: [Day.js](https://day.js.org/) v1.x
  - 轻量级（仅7KB）
  - 与Moment.js兼容的API
  - 支持链式调用

- **UI框架**: [Bootstrap 5](https://getbootstrap.com/)
  - 响应式设计
  - 丰富的UI组件
  - 原生JavaScript支持

### 系统架构图

```
┌─────────────────────────────────────────────────────────┐
│                     浏览器环境                            │
│                                                         │
│  ┌───────────────────────────────────────────────────┐  │
│  │              用户界面层 (UI Layer)                  │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐           │  │
│  │  │文件上传 │  │数据预览 │  │图表展示 │           │  │
│  │  └─────────┘  └─────────┘  └─────────┘           │  │
│  └───────────────────────────────────────────────────┘  │
│                         ↓                               │
│  ┌───────────────────────────────────────────────────┐  │
│  │           业务逻辑层 (Business Logic)              │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐           │  │
│  │  │数据验证 │  │数据转换 │  │图表生成 │           │  │
│  │  └─────────┘  └─────────┘  └─────────┘           │  │
│  └───────────────────────────────────────────────────┘  │
│                         ↓                               │
│  ┌───────────────────────────────────────────────────┐  │
│  │           数据处理层 (Data Processing)             │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐           │  │
│  │  │Excel解析│  │数据清洗 │  │数据导出 │           │  │
│  │  └─────────┘  └─────────┘  └─────────┘           │  │
│  └───────────────────────────────────────────────────┘  │
│                         ↓                               │
│  ┌───────────────────────────────────────────────────┐  │
│  │          工具库层 (Utility Libraries)              │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐           │  │
│  │  │SheetJS  │  │ECharts  │  │Day.js   │           │  │
│  │  └─────────┘  └─────────┘  └─────────┘           │  │
│  │  ┌─────────┐  ┌─────────┐                        │  │
│  │  │dateUtils│  │helpers  │  Bootstrap 5           │  │
│  │  └─────────┘  └─────────┘                        │  │
│  └───────────────────────────────────────────────────┘  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 核心模块设计

### 1. 文件上传模块 (FileUploader)

**职责**: 处理Excel文件选择和读取

**核心功能**:
- 文件拖拽上传
- 文件选择对话框
- 文件类型验证（.xlsx, .xls）
- 文件大小验证（最大50MB）
- FileReader API集成

**输入**: 用户选择的Excel文件  
**输出**: 文件内容（ArrayBuffer）

### 2. 数据解析模块 (DataParser)

**职责**: 解析Excel数据结构

**核心功能**:
- SheetJS工作簿解析
- 表头识别和列映射
- 必需列验证
- 数据行提取
- 数据类型转换

**输入**: Excel文件内容  
**输出**: 结构化的JavaScript对象数组

### 3. 数据验证模块 (DataValidator)

**职责**: 验证数据完整性和正确性

**核心功能**:
- 必需列存在性检查
- 数据类型验证
- 日期格式验证
- 空值检测
- 数据范围检查

**输入**: 原始数据数组  
**输出**: 验证结果报告（错误和警告）

### 4. 数据转换模块 (DataTransformer)

**职责**: 复刻VBA脚本的数据处理逻辑

**核心功能**:
1. 删除"合计"行
2. 车间列分列（提取区域）
3. 维修人分类（维修工/电工/未知）
4. 时间计算（等待时间、维修时间、故障时间）
5. 删除时间不完整的行

**输入**: 已验证的数据数组  
**输出**: 处理后的数据数组 + 处理统计信息

### 5. 数据导出模块 (DataExporter)

**职责**: 导出处理后的数据

**支持格式**:
- Excel (.xlsx) - 使用SheetJS生成
- CSV (.csv) - 文本格式
- JSON (.json) - 结构化数据

**输入**: 处理后的数据数组  
**输出**: 下载文件

### 6. 图表生成模块 (ChartGenerator)

**职责**: 基于处理后的数据生成ECharts图表

**支持的图表类型**:
- 故障时间趋势图
- 车间故障统计
- 维修人员工作量统计
- 故障类型分析

**输入**: 处理后的数据数组  
**输出**: ECharts配置对象

### 7. 工具函数模块 (Utils)

#### dateUtils.js - 日期处理工具
- `isValidDate()` - 验证日期有效性
- `parseExcelDate()` - 解析Excel日期序列号
- `formatDate()` - 格式化日期显示
- `getHoursDifference()` - 计算时间差（小时）

#### helpers.js - 通用辅助函数
- `formatFileSize()` - 格式化文件大小
- `showMessage()` - 用户消息通知
- `getElementById()` - 安全的DOM元素获取
- `debounce()` - 防抖函数
- `throttle()` - 节流函数
- `downloadFile()` - 文件下载辅助
- `escapeHtml()` - XSS防护

#### constants.js - 常量定义
- 列名定义（COLUMN_NAMES）
- 维修人员列表（REPAIR_WORKERS, ELECTRICIANS）
- 错误消息（MESSAGES）
- 应用配置（CONFIG）

## 数据流设计

### 主要数据流

```
用户选择Excel文件
    ↓
FileUploader读取文件
    ↓
SheetJS解析Excel → 原始工作簿对象
    ↓
DataParser提取数据 → 原始数据数组
    ↓
DataValidator验证数据 → 验证报告
    ↓
DataTransformer转换数据 → 处理后数据数组
    ↓
┌───────────────┬───────────────┐
↓               ↓               ↓
数据预览      图表展示        数据导出
```

### 数据结构

#### 原始数据格式
```javascript
{
  workOrder: string,        // 工单号
  workshop: string,         // 车间（可能包含区域）
  repairPerson: string,    // 维修人
  reportTime: Date,        // 报修时间
  startTime: Date,         // 维修开始时间
  endTime: Date,           // 维修结束时间
  // ... 其他字段
}
```

#### 处理后数据格式
```javascript
{
  workOrder: string,        // 工单号
  workshop: string,         // 车间（已分列）
  area: string,            // 区域（已提取）
  repairPerson: string,    // 维修人
  repairPersonType: string, // 维修人分类
  reportTime: Date,        // 报修时间
  startTime: Date,         // 维修开始时间
  endTime: Date,           // 维修结束时间
  waitTime: number,        // 等待时间（小时）
  repairTime: number,      // 维修时间（小时）
  faultTime: number,       // 故障时间（小时）
  // ... 其他字段
}
```

## 项目文件结构

```
Equipment-Fault-Statistics/
├── index.html                 # 主页面
├── css/
│   ├── main.css              # 主样式
│   └── components.css        # 组件样式
├── js/
│   ├── main.js               # 入口文件
│   ├── modules/              # 业务逻辑模块
│   │   ├── fileUploader.js
│   │   ├── dataParser.js
│   │   ├── dataValidator.js
│   │   ├── dataTransformer.js
│   │   ├── chartGenerator.js
│   │   └── dataExporter.js
│   ├── config/
│   │   └── constants.js
│   └── utils/
│       ├── dateUtils.js
│       └── helpers.js
├── lib/                       # 第三方库
│   ├── xlsx.full.min.js
│   ├── echarts.min.js
│   ├── dayjs.min.js
│   └── bootstrap/
└── docs/                      # 文档
```

## 性能考虑

### 大文件处理
- **问题**: Excel文件可能包含大量数据
- **解决方案**:
  - Web Worker后台处理
  - 分页显示数据
  - 虚拟滚动技术

### 内存管理
- **问题**: 大数据集可能占用过多内存
- **解决方案**:
  - 及时释放不用的数据
  - 流式处理
  - 数据分块处理

### 渲染优化
- **问题**: 大量数据渲染可能卡顿
- **解决方案**:
  - 图表数据采样
  - 懒加载
  - 防抖和节流

## 安全考虑

### 数据隐私
- ✅ 所有数据处理在本地完成
- ✅ 不向任何服务器发送数据
- ✅ 用户可离线使用

### 输入验证
- ✅ 验证文件类型
- ✅ 检查文件大小
- ✅ 防止XSS攻击

## 浏览器兼容性

### 支持的浏览器
- Chrome/Edge 90+
- Firefox 88+
- Safari 14+

### 关键API要求
- FileReader API ✅
- ES6+ 支持 ✅
- Web Worker（可选，用于性能优化）

## 扩展性设计

### 插件化图表
- 预留图表配置接口
- 支持自定义图表类型
- 可配置的图表选项

### 数据处理规则扩展
- 可配置的转换规则
- 支持自定义验证器
- 规则链模式

### 多语言支持
- 国际化(i18n)接口
- 默认中文
- 可扩展其他语言

## 相关文档

- [技术规格](技术规格) - VBA功能到JavaScript的映射
- [数据结构](数据结构) - 详细的数据格式定义
- [API文档](API文档) - 模块和函数API参考
- [开发指南](开发指南) - 开发计划和任务分解
