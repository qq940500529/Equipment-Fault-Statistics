# 数据结构

本文档详细定义了系统处理的数据格式、列名映射和转换规则。

## Excel输入数据格式

### 必需列

系统要求Excel文件必须包含以下列（列名可以是中文或英文）：

| 中文列名 | 英文列名 | 数据类型 | 说明 | 示例 |
|---------|---------|---------|------|------|
| 工单号 | Work Order | String | 唯一标识 | WO20240101001 |
| 车间 | Workshop | String | 车间名称，可能包含区域 | 一车间-A区 |
| 维修人 | Repair Person | String | 维修人员姓名 | 张三 |
| 报修时间 | Report Time | Date | 报修时间 | 2024-01-01 08:00:00 |
| 维修开始时间 | Start Time | Date | 维修开始时间 | 2024-01-01 09:30:00 |
| 维修结束时间 | End Time | Date | 维修结束时间 | 2024-01-01 11:00:00 |

### 可选列

这些列如果不存在，系统会自动创建：

| 中文列名 | 英文列名 | 数据类型 | 说明 |
|---------|---------|---------|------|
| 区域 | Area | String | 从车间列提取的区域信息 |
| 维修人分类 | Repair Person Type | String | 维修工/电工/未知 |
| 等待时间h | Wait Time (h) | Number | 计算得出的等待时间 |
| 维修时间h | Repair Time (h) | Number | 计算得出的维修时间 |
| 故障时间h | Fault Time (h) | Number | 计算得出的故障时间 |

## JavaScript内部数据结构

### 原始数据对象

```javascript
{
  workOrder: "WO20240101001",     // 工单号
  workshop: "一车间-A区",          // 车间（原始，可能包含区域）
  repairPerson: "张三",           // 维修人
  reportTime: Date,               // 报修时间（Date对象）
  startTime: Date,                // 维修开始时间（Date对象）
  endTime: Date,                  // 维修结束时间（Date对象）
  // ... 其他原始列
}
```

### 处理后数据对象

```javascript
{
  workOrder: "WO20240101001",     // 工单号
  workshop: "一车间",              // 车间（已分列）
  area: "A区",                    // 区域（已提取）
  repairPerson: "张三",           // 维修人
  repairPersonType: "维修工",     // 维修人分类
  reportTime: Date,               // 报修时间
  startTime: Date,                // 维修开始时间
  endTime: Date,                  // 维修结束时间
  waitTime: 1.5,                  // 等待时间（小时，2位小数）
  repairTime: 1.5,                // 维修时间（小时，2位小数）
  faultTime: 3.0,                 // 故障时间（小时，2位小数）
  // ... 其他列
}
```

### 验证结果对象

```javascript
{
  valid: true,                    // 是否验证通过
  errors: [                       // 错误数组
    {
      row: 5,                     // 行号
      column: "reportTime",       // 列名
      message: "报修时间格式无效"  // 错误信息
    }
  ],
  warnings: [                     // 警告数组
    {
      row: 10,
      column: "workshop",
      message: "车间列不包含区域信息"
    }
  ],
  summary: {                      // 验证摘要
    totalRows: 100,
    validRows: 95,
    errorCount: 5,
    warningCount: 10
  }
}
```

### 处理统计对象

```javascript
{
  originalRowCount: 100,          // 原始行数
  processedRowCount: 85,          // 处理后行数
  deletedSubtotalRows: 5,         // 删除的合计行数
  deletedIncompleteRows: 10,      // 删除的时间不完整行数
  validDataRate: "85.00%"         // 有效数据率
}
```

## 列名映射

系统支持中英文列名自动识别和映射：

```javascript
const COLUMN_NAMES = {
  // 工单号
  workOrder: ['工单号', 'Work Order', 'WorkOrder', 'Order No'],
  
  // 车间
  workshop: ['车间', 'Workshop', '工作车间'],
  
  // 区域
  area: ['区域', 'Area', '工作区域'],
  
  // 维修人
  repairPerson: ['维修人', 'Repair Person', 'RepairPerson', '维修员'],
  
  // 维修人分类
  repairPersonType: ['维修人分类', 'Repair Person Type', '人员分类'],
  
  // 报修时间
  reportTime: ['报修时间', 'Report Time', 'ReportTime', '报告时间'],
  
  // 维修开始时间
  startTime: ['维修开始时间', 'Start Time', 'StartTime', '开始时间'],
  
  // 维修结束时间
  endTime: ['维修结束时间', 'End Time', 'EndTime', '结束时间'],
  
  // 等待时间
  waitTime: ['等待时间h', 'Wait Time (h)', 'WaitTime', '等待时间'],
  
  // 维修时间
  repairTime: ['维修时间h', 'Repair Time (h)', 'RepairTime'],
  
  // 故障时间
  faultTime: ['故障时间h', 'Fault Time (h)', 'FaultTime', '总时间']
};
```

## 数据转换规则

### 规则1: 删除"合计"行

**识别条件**:
```javascript
row.workshop === "合计"
```

**处理方式**:
- 从数据数组中删除该行
- 统计删除的行数

### 规则2: 车间列分列

**识别条件**:
```javascript
row.workshop && row.workshop.includes('-')
```

**处理方式**:
```javascript
const parts = row.workshop.split('-');
row.workshop = parts[0].trim();  // "一车间"
row.area = parts[1] ? parts[1].trim() : '';  // "A区"
```

**示例**:
- 输入: `"一车间-A区"`
- 输出: `workshop: "一车间"`, `area: "A区"`

### 规则3: 维修人分类

**维修工名单** (16人):
```
王兴森, 孙长青, 徐阴海, 任扶民, 吴长振, 张玉柱, 
刘志强, 杨明印, 张金华, 刘金财, 崔树立, 杨致敬,
马圣强, 刘子凯, 何洪杰, 刘佳文
```

**电工名单** (14人):
```
李润海, 赵艳伟, 吴霄, 吴忠建, 李之彦, 宋桂良,
崔金辉, 李瑞召, 万庆权, 郭瑞臣, 郭兆勤, 赵同宽,
肖木凯, 赵燕伟
```

**分类逻辑**:
```javascript
function classifyRepairPerson(name) {
  const trimmedName = name.trim();
  if (REPAIR_WORKERS.includes(trimmedName)) {
    return '维修工';
  }
  if (ELECTRICIANS.includes(trimmedName)) {
    return '电工';
  }
  return '未知';
}
```

### 规则4: 时间计算

**等待时间** (小时):
```javascript
waitTime = (startTime - reportTime) / (1000 * 60 * 60)
waitTime = Math.round(waitTime * 100) / 100  // 保留2位小数
```

**维修时间** (小时):
```javascript
repairTime = (endTime - startTime) / (1000 * 60 * 60)
repairTime = Math.round(repairTime * 100) / 100
```

**故障时间** (小时):
```javascript
faultTime = waitTime + repairTime
faultTime = Math.round(faultTime * 100) / 100
```

**示例**:
- 报修时间: `2024-01-01 08:00:00`
- 维修开始: `2024-01-01 09:30:00`
- 维修结束: `2024-01-01 11:00:00`
- 结果:
  - 等待时间: `1.50` 小时
  - 维修时间: `1.50` 小时
  - 故障时间: `3.00` 小时

### 规则5: 删除时间不完整行

**删除条件**:
```javascript
!row.reportTime || 
!row.startTime || 
!row.endTime ||
!isValidDate(row.reportTime) ||
!isValidDate(row.startTime) ||
!isValidDate(row.endTime)
```

**时间验证**:
- 所有三个时间字段必须存在
- 必须是有效的日期对象
- 不能是 `null` 或 `undefined`
- 不能是无效日期（`Invalid Date`）

## 日期格式支持

系统支持以下日期格式：

### Excel日期格式
- Excel序列号（如 `44927.5` 表示某个日期和时间）
- 通过 `parseExcelDate()` 函数转换

### 文本日期格式
- ISO 8601: `2024-01-01T08:00:00`
- 中国标准: `2024-01-01 08:00:00`
- 短格式: `2024/01/01 08:00`
- 其他JavaScript Date可解析的格式

### 日期验证

```javascript
function isValidDate(date) {
  if (!date) return false;
  if (!(date instanceof Date)) return false;
  return !isNaN(date.getTime());
}
```

## 数据验证规则

### 必需列验证
- 检查所有必需列是否存在
- 如果缺少任何必需列，返回错误

### 数据类型验证
- 工单号: 字符串（非空）
- 车间: 字符串（非空）
- 维修人: 字符串（非空）
- 时间字段: 有效的Date对象

### 数据完整性验证
- 检查是否有空值
- 检查日期字段的有效性
- 检查数值字段的合理性

### 警告级别验证
- 车间列不包含区域信息（警告）
- 维修人不在名单中（警告）
- 时间顺序不合理（警告）

## 边界情况处理

### 空值处理
- 字符串字段: 空字符串 `""`
- 数值字段: `null` 或 `0`
- 日期字段: `null`

### 异常值处理
- 负数时间差: 设为 `0`
- 过大的时间差: 记录警告但保留数据
- 特殊字符: 自动trim处理

### 格式不标准处理
- 车间列无"-": 保持原值，区域为空
- 姓名有空格: 自动trim
- 日期格式多样: 尝试多种解析方式

## 导出数据格式

### Excel格式
- 使用SheetJS生成 `.xlsx` 文件
- 保留所有列和格式
- 日期格式化为 `YYYY-MM-DD HH:mm:ss`

### CSV格式
- UTF-8编码（带BOM）
- 逗号分隔
- 双引号包裹含逗号的字段
- 第一行为列名

### JSON格式
- 标准JSON数组
- 日期转换为ISO 8601字符串
- 美化输出（缩进2空格）

```json
[
  {
    "workOrder": "WO20240101001",
    "workshop": "一车间",
    "area": "A区",
    "repairPerson": "张三",
    "repairPersonType": "维修工",
    "reportTime": "2024-01-01T08:00:00.000Z",
    "startTime": "2024-01-01T09:30:00.000Z",
    "endTime": "2024-01-01T11:00:00.000Z",
    "waitTime": 1.5,
    "repairTime": 1.5,
    "faultTime": 3.0
  }
]
```

## 相关文档

- [技术规格](技术规格) - VBA功能映射详解
- [API文档](API文档) - 数据处理函数API
- [使用指南](使用指南) - 数据格式要求说明
