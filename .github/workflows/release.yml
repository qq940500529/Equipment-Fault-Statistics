name: Create Release Package

on:
  workflow_dispatch:
    inputs:
      confirm_version:
        description: 'Confirm version from package.json'
        required: true
        type: string

permissions:
  contents: write

jobs:
  validate-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Fetch all history for version checking

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '18'

      - name: Extract version from package.json
        id: package_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Package.json version: $VERSION"

      - name: Validate input version matches package.json
        run: |
          PACKAGE_VERSION="${{ steps.package_version.outputs.version }}"
          INPUT_VERSION="${{ github.event.inputs.confirm_version }}"
          
          echo "Comparing versions:"
          echo "  Package.json: $PACKAGE_VERSION"
          echo "  User input:   $INPUT_VERSION"
          
          if [ "$PACKAGE_VERSION" != "$INPUT_VERSION" ]; then
            echo "‚ùå Error: Version mismatch!"
            echo "The version you entered ($INPUT_VERSION) does not match package.json ($PACKAGE_VERSION)"
            echo "Please update package.json or enter the correct version."
            exit 1
          fi
          echo "‚úÖ Version validated: $PACKAGE_VERSION"

      - name: Check if release already exists
        id: check_release
        run: |
          VERSION="${{ steps.package_version.outputs.version }}"
          TAG="v$VERSION"
          
          echo "Checking if release $TAG already exists..."
          
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "‚ùå Error: Release $TAG already exists!"
            echo "Please update the version in package.json before creating a new release."
            echo ""
            echo "Existing release details:"
            gh release view "$TAG"
            exit 1
          fi
          
          echo "‚úÖ No existing release found for $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Get all releases for version comparison
        id: list_releases
        run: |
          echo "üìã Listing all existing releases:"
          gh release list --limit 50 || echo "No releases found"
          
          echo ""
          echo "Validating version is newer than previous releases..."
          
          VERSION="${{ steps.package_version.outputs.version }}"
          LATEST_RELEASE=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null | sed 's/^v//' || echo "")
          
          if [ -n "$LATEST_RELEASE" ]; then
            echo "Latest release version: $LATEST_RELEASE"
            echo "New version: $VERSION"
            
            # Check if versions are identical
            if [ "$VERSION" = "$LATEST_RELEASE" ]; then
              echo "‚ùå Error: Version $VERSION is the same as the latest release"
              exit 1
            fi
            
            # Semantic version comparison function
            compare_versions() {
                local ver1=$1
                local ver2=$2
                
                # Split versions into arrays
                IFS='.' read -ra V1 <<< "$ver1"
                IFS='.' read -ra V2 <<< "$ver2"
                
                # Compare major, minor, patch
                for i in 0 1 2; do
                    local v1_part=${V1[$i]:-0}
                    local v2_part=${V2[$i]:-0}
                    
                    if [ "$v1_part" -gt "$v2_part" ]; then
                        return 0  # ver1 > ver2
                    elif [ "$v1_part" -lt "$v2_part" ]; then
                        return 1  # ver1 < ver2
                    fi
                done
                
                return 2  # versions are equal
            }
            
            if compare_versions "$VERSION" "$LATEST_RELEASE"; then
              echo "‚úÖ New version $VERSION is newer than latest release $LATEST_RELEASE"
            else
              echo "‚ùå Error: New version $VERSION is not newer than latest release $LATEST_RELEASE"
              echo "Please update package.json with a version number higher than $LATEST_RELEASE"
              exit 1
            fi
          else
            echo "‚ÑπÔ∏è  No previous releases found. This will be the first release."
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create release package
        run: |
          VERSION="${{ steps.package_version.outputs.version }}"
          PACKAGE_NAME="equipment-fault-statistics-v${VERSION}"
          
          echo "üì¶ Creating release package: $PACKAGE_NAME"
          
          # Create temporary directory for packaging
          mkdir -p "release-temp/$PACKAGE_NAME"
          
          # Copy core application files
          echo "Copying core application files..."
          cp index.html "release-temp/$PACKAGE_NAME/"
          cp -r css "release-temp/$PACKAGE_NAME/"
          cp -r js "release-temp/$PACKAGE_NAME/"
          cp -r lib "release-temp/$PACKAGE_NAME/"
          
          # Copy essential root files
          cp README.md "release-temp/$PACKAGE_NAME/"
          cp LICENSE "release-temp/$PACKAGE_NAME/"
          cp CHANGELOG.md "release-temp/$PACKAGE_NAME/"
          
          # Create archive
          cd release-temp
          zip -r "../${PACKAGE_NAME}.zip" "$PACKAGE_NAME"
          cd ..
          
          # Create checksum
          sha256sum "${PACKAGE_NAME}.zip" > "${PACKAGE_NAME}.zip.sha256"
          
          echo "‚úÖ Package created successfully"
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "package_file=${PACKAGE_NAME}.zip" >> $GITHUB_OUTPUT
          
          # Display package contents
          echo ""
          echo "üìã Package contents:"
          unzip -l "${PACKAGE_NAME}.zip" | head -50
          
          # Display package size
          echo ""
          echo "üìä Package size:"
          ls -lh "${PACKAGE_NAME}.zip"
        id: create_package

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ steps.package_version.outputs.version }}"
          
          cat > release_notes.md << EOF
          ## ËÆæÂ§áÊïÖÈöúÁªüËÆ°Á≥ªÁªü v${VERSION}
          
          ### üì¶ ÂèëÂ∏ÉËØ¥Êòé
          
          ËøôÊòØ‰∏Ä‰∏™Á∫ØÂâçÁ´ØÁöÑËÆæÂ§áÊïÖÈöúÊï∞ÊçÆÂ§ÑÁêÜ‰∏éÂèØËßÜÂåñÂπ≥Âè∞ÔºåÁî®‰∫éÂ§ÑÁêÜËÆæÂ§áÁª¥‰øÆËÆ∞ÂΩïÁöÑExcelÊï∞ÊçÆÔºåÂπ∂ÁîüÊàêÁªüËÆ°ÂõæË°®„ÄÇ
          
          ### üöÄ Ê†∏ÂøÉÂäüËÉΩ
          
          - ‚úÖ ExcelÊñá‰ª∂‰∏ä‰º†‰∏éËß£ÊûêÔºàÊîØÊåÅ.xlsxÂíå.xlsÊ†ºÂºèÔºâ
          - ‚úÖ Êï∞ÊçÆÊ∏ÖÊ¥ó‰∏éËΩ¨Êç¢ÔºàÂ§çÂàªVBAËÑöÊú¨ÈÄªËæëÔºâ
          - ‚úÖ Êï∞ÊçÆÈ™åËØÅ‰∏éË¥®ÈáèÊ£ÄÊü•
          - ‚úÖ ÁªìÊûúÂØºÂá∫ÔºàExcel„ÄÅCSV„ÄÅJSONÊ†ºÂºèÔºâ
          
          ### üì• ‰ΩøÁî®ÊñπÊ≥ï
          
          1. ‰∏ãËΩΩÂπ∂Ëß£Âéã \`equipment-fault-statistics-v${VERSION}.zip\`
          2. ÂèåÂáªÊâìÂºÄ \`index.html\` Êñá‰ª∂
          3. ÊåâÁÖßÁïåÈù¢ÊèêÁ§∫‰∏ä‰º†ExcelÊñá‰ª∂Âπ∂Â§ÑÁêÜÊï∞ÊçÆ
          
          ### üì¶ ÂåÖÂê´ÂÜÖÂÆπ
          
          - \`index.html\` - Â∫îÁî®‰∏ªÈ°µÈù¢
          - \`css/\` - Ê†∑ÂºèÊñá‰ª∂
          - \`js/\` - JavaScriptÊ∫ê‰ª£Á†Å
          - \`lib/\` - Á¨¨‰∏âÊñπÂ∫ìÔºàÊîØÊåÅÁ¶ªÁ∫ø‰ΩøÁî®Ôºâ
          - \`README.md\` - ‰ΩøÁî®ËØ¥Êòé
          - \`LICENSE\` - MITËÆ∏ÂèØËØÅ
          - \`CHANGELOG.md\` - ÂèòÊõ¥Êó•Âøó
          
          ### üîç È™åËØÅ‰∏ãËΩΩ
          
          ‰ΩøÁî® SHA256 Ê†°È™åÂíåÈ™åËØÅ‰∏ãËΩΩÂÆåÊï¥ÊÄßÔºö
          \`\`\`bash
          sha256sum -c equipment-fault-statistics-v${VERSION}.zip.sha256
          \`\`\`
          
          ### üìö ÊñáÊ°£
          
          ËØ¶ÁªÜ‰ΩøÁî®ËØ¥ÊòéÂíåÊñáÊ°£ËØ∑ËÆøÈóÆÔºö
          - [GitHub ‰ªìÂ∫ì](https://github.com/qq940500529/Equipment-Fault-Statistics)
          - [Âú®Á∫øÊºîÁ§∫](https://qq940500529.github.io/Equipment-Fault-Statistics/)
          
          ### ‚ö†Ô∏è Ê≥®ÊÑè‰∫ãÈ°π
          
          - Ê≠§ÂåÖ‰ªÖÂåÖÂê´Ê†∏ÂøÉÂ∫îÁî®Á®ãÂ∫èÔºå‰∏çÂåÖÂê´ÊµãËØïÂíåÂºÄÂèëÊñáÊ°£
          - ÂÆåÊï¥Ê∫ê‰ª£Á†ÅÂíåÊñáÊ°£ËØ∑ËÆøÈóÆ GitHub ‰ªìÂ∫ì
          - ÊâÄÊúâÊï∞ÊçÆÂ§ÑÁêÜÂùáÂú®ÂÆ¢Êà∑Á´ØÂÆåÊàêÔºåÊó†ÈúÄÁΩëÁªúËøûÊé•
          - Êï∞ÊçÆ‰∏ç‰ºö‰∏ä‰º†Âà∞ÊúçÂä°Âô®ÔºåÂÆåÂÖ®Êú¨Âú∞Â§ÑÁêÜ
          
          EOF
          
          echo "Release notes generated"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.check_release.outputs.tag }}"
          PACKAGE_FILE="${{ steps.create_package.outputs.package_file }}"
          VERSION="${{ steps.package_version.outputs.version }}"
          
          echo "Creating release $TAG..."
          
          gh release create "$TAG" \
            --title "Release v$VERSION" \
            --notes-file release_notes.md \
            "$PACKAGE_FILE" \
            "${PACKAGE_FILE}.sha256"
          
          echo "‚úÖ Release created successfully!"
          echo ""
          echo "üéâ Release URL:"
          gh release view "$TAG" --web

      - name: Summary
        run: |
          VERSION="${{ steps.package_version.outputs.version }}"
          TAG="${{ steps.check_release.outputs.tag }}"
          
          echo "## ‚úÖ Release Created Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: $TAG" >> $GITHUB_STEP_SUMMARY
          echo "- **Package**: equipment-fault-statistics-v${VERSION}.zip" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Package Contents" >> $GITHUB_STEP_SUMMARY
          echo "- Core application files (HTML, CSS, JS)" >> $GITHUB_STEP_SUMMARY
          echo "- Third-party libraries (offline support)" >> $GITHUB_STEP_SUMMARY
          echo "- README.md, LICENSE, CHANGELOG.md" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚ö†Ô∏è Excluded from Release" >> $GITHUB_STEP_SUMMARY
          echo "- Tests and test files" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation (docs/)" >> $GITHUB_STEP_SUMMARY
          echo "- Examples (examples/)" >> $GITHUB_STEP_SUMMARY
          echo "- Development files (jest.config.js, package.json, etc.)" >> $GITHUB_STEP_SUMMARY
