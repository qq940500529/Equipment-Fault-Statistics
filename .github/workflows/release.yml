name: Create Release Package

on:
  workflow_dispatch:
    inputs:
      confirm_version:
        description: 'Confirm version from package.json'
        required: true
        type: string

permissions:
  contents: write

jobs:
  validate-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Fetch all history for version checking

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '18'

      - name: Extract version from package.json
        id: package_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Package.json version: $VERSION"

      - name: Validate input version matches package.json
        run: |
          PACKAGE_VERSION="${{ steps.package_version.outputs.version }}"
          INPUT_VERSION="${{ github.event.inputs.confirm_version }}"
          
          echo "Comparing versions:"
          echo "  Package.json: $PACKAGE_VERSION"
          echo "  User input:   $INPUT_VERSION"
          
          if [ "$PACKAGE_VERSION" != "$INPUT_VERSION" ]; then
            echo "âŒ Error: Version mismatch!"
            echo "The version you entered ($INPUT_VERSION) does not match package.json ($PACKAGE_VERSION)"
            echo "Please update package.json or enter the correct version."
            exit 1
          fi
          echo "âœ… Version validated: $PACKAGE_VERSION"

      - name: Check if release already exists
        id: check_release
        run: |
          VERSION="${{ steps.package_version.outputs.version }}"
          TAG="v$VERSION"
          
          echo "Checking if release $TAG already exists..."
          
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "âŒ Error: Release $TAG already exists!"
            echo "Please update the version in package.json before creating a new release."
            echo ""
            echo "Existing release details:"
            gh release view "$TAG"
            exit 1
          fi
          
          echo "âœ… No existing release found for $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Get all releases for version comparison
        id: list_releases
        run: |
          echo "ðŸ“‹ Listing all existing releases:"
          gh release list --limit 50 || echo "No releases found"
          
          echo ""
          echo "Validating version is newer than previous releases..."
          
          VERSION="${{ steps.package_version.outputs.version }}"
          LATEST_RELEASE=$(gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null | sed 's/^v//' || echo "")
          
          if [ -n "$LATEST_RELEASE" ]; then
            echo "Latest release version: $LATEST_RELEASE"
            echo "New version: $VERSION"
            
            # Simple version comparison (works for semantic versioning)
            if [ "$VERSION" = "$LATEST_RELEASE" ]; then
              echo "âŒ Error: Version $VERSION is the same as the latest release"
              exit 1
            fi
            
            # Note: This is a basic check. For production, consider using semver comparison
            echo "âš ï¸  Warning: Please ensure $VERSION is newer than $LATEST_RELEASE"
            echo "âœ… Proceeding with release creation"
          else
            echo "â„¹ï¸  No previous releases found. This will be the first release."
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create release package
        run: |
          VERSION="${{ steps.package_version.outputs.version }}"
          PACKAGE_NAME="equipment-fault-statistics-v${VERSION}"
          
          echo "ðŸ“¦ Creating release package: $PACKAGE_NAME"
          
          # Create temporary directory for packaging
          mkdir -p "release-temp/$PACKAGE_NAME"
          
          # Copy core application files
          echo "Copying core application files..."
          cp index.html "release-temp/$PACKAGE_NAME/"
          cp -r css "release-temp/$PACKAGE_NAME/"
          cp -r js "release-temp/$PACKAGE_NAME/"
          cp -r lib "release-temp/$PACKAGE_NAME/"
          
          # Copy essential root files
          cp README.md "release-temp/$PACKAGE_NAME/"
          cp LICENSE "release-temp/$PACKAGE_NAME/"
          cp CHANGELOG.md "release-temp/$PACKAGE_NAME/"
          
          # Create archive
          cd release-temp
          zip -r "../${PACKAGE_NAME}.zip" "$PACKAGE_NAME"
          cd ..
          
          # Create checksum
          sha256sum "${PACKAGE_NAME}.zip" > "${PACKAGE_NAME}.zip.sha256"
          
          echo "âœ… Package created successfully"
          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "package_file=${PACKAGE_NAME}.zip" >> $GITHUB_OUTPUT
          
          # Display package contents
          echo ""
          echo "ðŸ“‹ Package contents:"
          unzip -l "${PACKAGE_NAME}.zip" | head -50
          
          # Display package size
          echo ""
          echo "ðŸ“Š Package size:"
          ls -lh "${PACKAGE_NAME}.zip"
        id: create_package

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ steps.package_version.outputs.version }}"
          
          cat > release_notes.md << 'EOF'
          ## è®¾å¤‡æ•…éšœç»Ÿè®¡ç³»ç»Ÿ v$VERSION
          
          ### ðŸ“¦ å‘å¸ƒè¯´æ˜Ž
          
          è¿™æ˜¯ä¸€ä¸ªçº¯å‰ç«¯çš„è®¾å¤‡æ•…éšœæ•°æ®å¤„ç†ä¸Žå¯è§†åŒ–å¹³å°ï¼Œç”¨äºŽå¤„ç†è®¾å¤‡ç»´ä¿®è®°å½•çš„Excelæ•°æ®ï¼Œå¹¶ç”Ÿæˆç»Ÿè®¡å›¾è¡¨ã€‚
          
          ### ðŸš€ æ ¸å¿ƒåŠŸèƒ½
          
          - âœ… Excelæ–‡ä»¶ä¸Šä¼ ä¸Žè§£æžï¼ˆæ”¯æŒ.xlsxå’Œ.xlsæ ¼å¼ï¼‰
          - âœ… æ•°æ®æ¸…æ´—ä¸Žè½¬æ¢ï¼ˆå¤åˆ»VBAè„šæœ¬é€»è¾‘ï¼‰
          - âœ… æ•°æ®éªŒè¯ä¸Žè´¨é‡æ£€æŸ¥
          - âœ… ç»“æžœå¯¼å‡ºï¼ˆExcelã€CSVã€JSONæ ¼å¼ï¼‰
          
          ### ðŸ“¥ ä½¿ç”¨æ–¹æ³•
          
          1. ä¸‹è½½å¹¶è§£åŽ‹ `equipment-fault-statistics-v$VERSION.zip`
          2. åŒå‡»æ‰“å¼€ `index.html` æ–‡ä»¶
          3. æŒ‰ç…§ç•Œé¢æç¤ºä¸Šä¼ Excelæ–‡ä»¶å¹¶å¤„ç†æ•°æ®
          
          ### ðŸ“¦ åŒ…å«å†…å®¹
          
          - `index.html` - åº”ç”¨ä¸»é¡µé¢
          - `css/` - æ ·å¼æ–‡ä»¶
          - `js/` - JavaScriptæºä»£ç 
          - `lib/` - ç¬¬ä¸‰æ–¹åº“ï¼ˆæ”¯æŒç¦»çº¿ä½¿ç”¨ï¼‰
          - `README.md` - ä½¿ç”¨è¯´æ˜Ž
          - `LICENSE` - MITè®¸å¯è¯
          - `CHANGELOG.md` - å˜æ›´æ—¥å¿—
          
          ### ðŸ” éªŒè¯ä¸‹è½½
          
          ä½¿ç”¨ SHA256 æ ¡éªŒå’ŒéªŒè¯ä¸‹è½½å®Œæ•´æ€§ï¼š
          ```bash
          sha256sum -c equipment-fault-statistics-v$VERSION.zip.sha256
          ```
          
          ### ðŸ“š æ–‡æ¡£
          
          è¯¦ç»†ä½¿ç”¨è¯´æ˜Žå’Œæ–‡æ¡£è¯·è®¿é—®ï¼š
          - [GitHub ä»“åº“](https://github.com/qq940500529/Equipment-Fault-Statistics)
          - [åœ¨çº¿æ¼”ç¤º](https://qq940500529.github.io/Equipment-Fault-Statistics/)
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          
          - æ­¤åŒ…ä»…åŒ…å«æ ¸å¿ƒåº”ç”¨ç¨‹åºï¼Œä¸åŒ…å«æµ‹è¯•å’Œå¼€å‘æ–‡æ¡£
          - å®Œæ•´æºä»£ç å’Œæ–‡æ¡£è¯·è®¿é—® GitHub ä»“åº“
          - æ‰€æœ‰æ•°æ®å¤„ç†å‡åœ¨å®¢æˆ·ç«¯å®Œæˆï¼Œæ— éœ€ç½‘ç»œè¿žæŽ¥
          - æ•°æ®ä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œå®Œå…¨æœ¬åœ°å¤„ç†
          
          EOF
          
          # Replace version placeholder
          sed -i "s/\$VERSION/$VERSION/g" release_notes.md
          
          echo "Release notes generated"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.check_release.outputs.tag }}"
          PACKAGE_FILE="${{ steps.create_package.outputs.package_file }}"
          VERSION="${{ steps.package_version.outputs.version }}"
          
          echo "Creating release $TAG..."
          
          gh release create "$TAG" \
            --title "Release v$VERSION" \
            --notes-file release_notes.md \
            "$PACKAGE_FILE" \
            "${PACKAGE_FILE}.sha256"
          
          echo "âœ… Release created successfully!"
          echo ""
          echo "ðŸŽ‰ Release URL:"
          gh release view "$TAG" --web

      - name: Summary
        run: |
          VERSION="${{ steps.package_version.outputs.version }}"
          TAG="${{ steps.check_release.outputs.tag }}"
          
          echo "## âœ… Release Created Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: $TAG" >> $GITHUB_STEP_SUMMARY
          echo "- **Package**: equipment-fault-statistics-v${VERSION}.zip" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Package Contents" >> $GITHUB_STEP_SUMMARY
          echo "- Core application files (HTML, CSS, JS)" >> $GITHUB_STEP_SUMMARY
          echo "- Third-party libraries (offline support)" >> $GITHUB_STEP_SUMMARY
          echo "- README.md, LICENSE, CHANGELOG.md" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Excluded from Release" >> $GITHUB_STEP_SUMMARY
          echo "- Tests and test files" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation (docs/)" >> $GITHUB_STEP_SUMMARY
          echo "- Examples (examples/)" >> $GITHUB_STEP_SUMMARY
          echo "- Development files (jest.config.js, package.json, etc.)" >> $GITHUB_STEP_SUMMARY
