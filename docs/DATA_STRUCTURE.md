# 数据结构文档 (Data Structure Documentation)

## 1. 概述

本文档详细描述了设备故障统计系统中使用的数据结构，包括输入数据格式、处理过程中的数据结构以及输出数据格式。

## 2. Excel输入数据格式

### 2.1 必需列

| 列名 | 数据类型 | 说明 | 示例 |
|------|---------|------|------|
| 工单号 | String | 维修工单的唯一标识符 | "WO20240101001" |
| 车间 | String | 设备所在车间，可能包含区域信息（用"-"分隔） | "一车间-A区" 或 "一车间" |
| 维修人 | String | 负责维修的人员姓名 | "王兴森" |
| 报修时间 | DateTime | 设备故障报修的时间 | "2024-01-01 08:30:00" |
| 维修开始时间 | DateTime | 维修人员开始维修的时间 | "2024-01-01 10:00:00" |
| 维修结束时间 | DateTime | 维修完成的时间 | "2024-01-01 12:30:00" |

### 2.2 可选列

| 列名 | 数据类型 | 说明 | 处理方式 |
|------|---------|------|---------|
| 区域 | String | 设备所在区域 | 如果存在则保留，否则从车间列提取 |
| 维修人分类 | String | 维修人员类型（维修工/电工） | 如果存在则保留，否则自动分类 |
| 等待时间h | Number | 等待维修的时间（小时） | 如果存在则保留，否则自动计算 |
| 维修时间h | Number | 实际维修时长（小时） | 如果存在则保留，否则自动计算 |
| 故障时间h | Number | 总故障时长（小时） | 如果存在则保留，否则自动计算 |

### 2.3 其他可能的列

系统会保留Excel中的所有其他列，不进行修改。常见的其他列包括：
- 设备名称
- 故障类型
- 故障描述
- 处理措施
- 备注
- 等等

### 2.4 特殊行处理

| 行类型 | 识别方式 | 处理方式 |
|--------|---------|---------|
| 表头行 | 第一行（或第一个数据行之前） | 用于识别列，不作为数据处理 |
| 合计行 | 车间列值为"合计" | 删除 |
| 空行 | 工单号为空 | 忽略或删除 |
| 时间不完整行 | 报修时间、维修开始时间、维修结束时间任一缺失或无效 | 删除 |

## 3. JavaScript内部数据结构

### 3.1 原始数据对象

从Excel解析后的原始数据对象结构：

```typescript
interface RawDataRow {
    工单号: string;
    车间: string;
    区域?: string;               // 可选
    维修人: string;
    维修人分类?: string;         // 可选
    报修时间: string | Date;
    维修开始时间: string | Date;
    维修结束时间: string | Date;
    等待时间h?: number;          // 可选
    维修时间h?: number;          // 可选
    故障时间h?: number;          // 可选
    [key: string]: any;         // 其他任意字段
}
```

**示例**:
```javascript
{
    "工单号": "WO20240101001",
    "车间": "一车间-A区",
    "维修人": "王兴森",
    "报修时间": "2024-01-01 08:30:00",
    "维修开始时间": "2024-01-01 10:00:00",
    "维修结束时间": "2024-01-01 12:30:00",
    "设备名称": "设备A",
    "故障类型": "机械故障"
}
```

### 3.2 列映射对象

用于记录各列在数组中的索引或在对象中的键名：

```typescript
interface ColumnMapping {
    workOrder: string | number;      // '工单号'
    workshop: string | number;       // '车间'
    area: string | number;          // '区域'
    repairPerson: string | number;  // '维修人'
    repairPersonType: string | number; // '维修人分类'
    reportTime: string | number;    // '报修时间'
    startTime: string | number;     // '维修开始时间'
    endTime: string | number;       // '维修结束时间'
    waitTime: string | number;      // '等待时间h'
    repairTime: string | number;    // '维修时间h'
    faultTime: string | number;     // '故障时间h'
}
```

**示例**:
```javascript
{
    workOrder: '工单号',
    workshop: '车间',
    area: '区域',
    repairPerson: '维修人',
    repairPersonType: '维修人分类',
    reportTime: '报修时间',
    startTime: '维修开始时间',
    endTime: '维修结束时间',
    waitTime: '等待时间h',
    repairTime: '维修时间h',
    faultTime: '故障时间h'
}
```

### 3.3 处理后数据对象

经过转换处理后的数据对象结构：

```typescript
interface ProcessedDataRow {
    工单号: string;
    车间: string;                // 已分列，不含区域信息
    区域: string;                // 从车间列提取或原有
    维修人: string;
    维修人分类: string;          // '维修工' | '电工' | '未知'
    报修时间: Date;
    维修开始时间: Date;
    维修结束时间: Date;
    等待时间h: number;           // 保留2位小数
    维修时间h: number;           // 保留2位小数
    故障时间h: number;           // 保留2位小数
    [key: string]: any;         // 其他字段保持不变
}
```

**示例**:
```javascript
{
    "工单号": "WO20240101001",
    "车间": "一车间",              // 已分列
    "区域": "A区",                // 已提取
    "维修人": "王兴森",
    "维修人分类": "维修工",        // 已分类
    "报修时间": "2024-01-01 08:30:00",
    "维修开始时间": "2024-01-01 10:00:00",
    "维修结束时间": "2024-01-01 12:30:00",
    "等待时间h": 1.50,            // 已计算
    "维修时间h": 2.50,            // 已计算
    "故障时间h": 4.00,            // 已计算
    "设备名称": "设备A",
    "故障类型": "机械故障"
}
```

### 3.4 处理统计对象

记录数据处理过程中的统计信息：

```typescript
interface ProcessingStats {
    totalRows: number;                    // 原始数据总行数
    deletedTotalRows: number;             // 删除的"合计"行数
    deletedIncompleteTimeRows: number;    // 删除的时间不完整行数
    processedRows: number;                // 最终处理后的行数
    hasAreaColumn: boolean;               // 是否已存在区域列
    hasRepairPersonTypeColumn: boolean;   // 是否已存在维修人分类列
}
```

**示例**:
```javascript
{
    totalRows: 1015,
    deletedTotalRows: 5,
    deletedIncompleteTimeRows: 10,
    processedRows: 1000,
    hasAreaColumn: false,
    hasRepairPersonTypeColumn: false
}
```

### 3.5 验证结果对象

数据验证的结果结构：

```typescript
interface ValidationResult {
    isValid: boolean;           // 是否通过验证
    errors: ValidationError[];  // 错误列表
    warnings: ValidationWarning[]; // 警告列表
}

interface ValidationError {
    type: string;               // 错误类型
    message: string;            // 错误消息
    row?: number;               // 出错的行号（可选）
    column?: string;            // 出错的列名（可选）
}

interface ValidationWarning {
    type: string;               // 警告类型
    message: string;            // 警告消息
    count?: number;             // 警告数量（可选）
}
```

**示例**:
```javascript
{
    isValid: false,
    errors: [
        {
            type: 'MISSING_COLUMN',
            message: '缺少必需列：工单号',
            column: '工单号'
        },
        {
            type: 'INVALID_DATE',
            message: '第5行的报修时间不是有效的日期格式',
            row: 5,
            column: '报修时间'
        }
    ],
    warnings: [
        {
            type: 'INCOMPLETE_TIME',
            message: '发现10行时间数据不完整，将被删除',
            count: 10
        }
    ]
}
```

## 4. 常量定义

### 4.1 维修人员名单

```javascript
// 维修工名单（16人）
const REPAIR_WORKERS = [
    '王兴森', '孙长青', '徐阴海', '任扶民',
    '吴长振', '张玉柱', '刘志强', '杨明印',
    '张金华', '刘金财', '崔树立', '杨致敬',
    '马圣强', '刘子凯', '何洪杰', '刘佳文'
];

// 电工名单（14人）
const ELECTRICIANS = [
    '李润海', '赵艳伟', '吴霄', '吴忠建',
    '李之彦', '宋桂良', '崔金辉', '李瑞召',
    '万庆权', '郭瑞臣', '郭兆勤', '赵同宽',
    '肖木凯', '赵燕伟'
];
```

### 4.2 列名常量

```javascript
const COLUMN_NAMES = {
    // 必需列
    WORK_ORDER: '工单号',
    WORKSHOP: '车间',
    REPAIR_PERSON: '维修人',
    REPORT_TIME: '报修时间',
    START_TIME: '维修开始时间',
    END_TIME: '维修结束时间',
    
    // 处理列
    AREA: '区域',
    REPAIR_PERSON_TYPE: '维修人分类',
    WAIT_TIME: '等待时间h',
    REPAIR_TIME: '维修时间h',
    FAULT_TIME: '故障时间h'
};
```

### 4.3 特殊值常量

```javascript
const SPECIAL_VALUES = {
    TOTAL: '合计',                    // 合计行标识
    UNKNOWN_PERSON_TYPE: '未知',       // 未知的维修人分类
    REPAIR_WORKER_TYPE: '维修工',      // 维修工分类
    ELECTRICIAN_TYPE: '电工'           // 电工分类
};
```

### 4.4 格式化常量

```javascript
const FORMAT = {
    TIME_DECIMALS: 2,                          // 时间保留小数位数
    DATE_TIME_FORMAT: 'YYYY-MM-DD HH:mm:ss',   // 日期时间格式
    WORKSHOP_SEPARATOR: '-'                    // 车间区域分隔符
};
```

## 5. 数据转换规则

### 5.1 车间分列规则

```
输入: "一车间-A区"
处理: 
  - 检查是否包含 "-"
  - 按 "-" 分割
  - 第一部分赋值给"车间"列
  - 第二部分赋值给"区域"列
输出: 
  - 车间: "一车间"
  - 区域: "A区"

输入: "一车间"
处理:
  - 不包含 "-"
  - 保持原值
输出:
  - 车间: "一车间"
  - 区域: ""
```

### 5.2 维修人分类规则

```
输入: "王兴森"
处理:
  - 在REPAIR_WORKERS中查找
  - 找到匹配
输出: "维修工"

输入: "李润海"
处理:
  - 在REPAIR_WORKERS中查找（未找到）
  - 在ELECTRICIANS中查找
  - 找到匹配
输出: "电工"

输入: "张三"
处理:
  - 在REPAIR_WORKERS中查找（未找到）
  - 在ELECTRICIANS中查找（未找到）
输出: "未知"

输入: "" (空)
处理:
  - 空值
输出: "未知"
```

### 5.3 时间计算规则

```
已知:
  - 报修时间: 2024-01-01 08:00:00
  - 维修开始时间: 2024-01-01 10:30:00
  - 维修结束时间: 2024-01-01 13:00:00

计算:
  - 等待时间 = (维修开始时间 - 报修时间) * 24
            = (10:30:00 - 08:00:00) * 24
            = 2.5 小时
            = 2.50 (保留2位小数)
  
  - 维修时间 = (维修结束时间 - 维修开始时间) * 24
            = (13:00:00 - 10:30:00) * 24
            = 2.5 小时
            = 2.50 (保留2位小数)
  
  - 故障时间 = 等待时间 + 维修时间
            = 2.50 + 2.50
            = 5.00 (保留2位小数)

输出:
  - 等待时间h: 2.50
  - 维修时间h: 2.50
  - 故障时间h: 5.00
```

## 6. 数据流示意图

```
Excel文件
    ↓
┌───────────────────────────────────┐
│  SheetJS解析                       │
│  - 读取工作表                      │
│  - 转换为二维数组或对象数组         │
└───────────────────────────────────┘
    ↓
原始数据数组/对象
    ↓
┌───────────────────────────────────┐
│  列识别                            │
│  - 查找必需列                      │
│  - 创建列映射                      │
└───────────────────────────────────┘
    ↓
列映射对象
    ↓
┌───────────────────────────────────┐
│  数据验证                          │
│  - 检查必需列                      │
│  - 检查数据类型                    │
│  - 检查日期格式                    │
└───────────────────────────────────┘
    ↓
验证结果
    ↓
┌───────────────────────────────────┐
│  数据转换                          │
│  1. 删除"合计"行                   │
│  2. 车间列分列                     │
│  3. 维修人分类                     │
│  4. 时间计算                       │
│  5. 删除时间不完整行               │
└───────────────────────────────────┘
    ↓
处理后数据数组
    ↓
┌───────────────────────────────────┐
│  数据输出                          │
│  - 生成Excel文件                   │
│  - 生成CSV文件                     │
│  - 显示预览                        │
│  - 生成图表                        │
└───────────────────────────────────┘
    ↓
输出结果
```

## 7. 边界情况处理

### 7.1 空值处理

| 字段 | 空值处理 |
|------|---------|
| 工单号 | 跳过该行 |
| 车间 | 如果为"合计"则删除，否则保留空值 |
| 维修人 | 分类为"未知" |
| 时间字段 | 删除该行 |
| 其他字段 | 保持原样 |

### 7.2 异常值处理

| 异常类型 | 处理方式 |
|---------|---------|
| 车间包含多个"-" | 只按第一个"-"分割 |
| 时间格式不标准 | 尝试多种格式解析，失败则删除行 |
| 时间逻辑错误（如结束时间早于开始时间） | 仍然计算，结果可能为负数 |
| 维修人包含空格 | 自动trim后再匹配 |

### 7.3 大小写处理

- 维修人姓名: 区分大小写，需完全匹配
- 列名: 区分大小写，需完全匹配
- "合计": 区分大小写，需完全匹配

## 8. 性能考虑

### 8.1 数据量限制建议

| 数据量 | 处理方式 | 预计耗时 |
|--------|---------|---------|
| < 1,000行 | 同步处理 | < 1秒 |
| 1,000 - 10,000行 | 同步处理 | 1-5秒 |
| 10,000 - 100,000行 | 异步处理（Web Worker） | 5-30秒 |
| > 100,000行 | 分批异步处理 | > 30秒 |

### 8.2 内存占用估算

- 每行数据约占用: 500-1000 bytes
- 1,000行约占用: 0.5-1 MB
- 10,000行约占用: 5-10 MB
- 100,000行约占用: 50-100 MB

## 9. 版本兼容性

### 9.1 向前兼容

未来版本需要保证能够处理当前版本生成的数据格式。

### 9.2 向后兼容

尽可能支持旧版本的Excel数据格式，通过以下方式：
- 灵活的列名匹配（支持同义词）
- 多种日期格式支持
- 可选列的自动检测

## 10. 总结

本文档详细定义了系统中所有数据结构和转换规则，为开发提供了明确的规范。所有数据处理必须严格遵循这些定义，以确保与VBA脚本的行为一致。
