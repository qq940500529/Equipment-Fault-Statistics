# 设备故障统计系统 - 架构设计文档

## 1. 系统概述

本系统是一个纯前端的设备故障数据处理与可视化平台，用于处理设备维修记录的Excel数据，并生成统计图表。系统完全运行在浏览器端，无需后端服务器部署。

### 1.1 核心功能
- Excel文件上传与解析
- 数据清洗与转换（复刻VBA功能）
- 数据可视化（ECharts图表）
- 结果导出

### 1.2 技术特点
- **零部署**: 纯静态HTML/CSS/JavaScript，可直接在浏览器中运行
- **离线运行**: 所有处理均在客户端完成，无需网络连接
- **数据安全**: 数据不上传到服务器，完全本地处理

## 2. 技术架构

### 2.1 技术栈选型

#### 核心框架
- **前端框架**: 原生JavaScript (ES6+) 或 Vue.js 3
  - 原生JavaScript: 零依赖，最轻量
  - Vue.js 3: 更好的组件化和状态管理
  
#### 关键库
- **Excel处理**: SheetJS (xlsx)
  - 功能: 读取和写入Excel文件
  - 优势: 纯JavaScript实现，功能完整
  
- **图表库**: Apache ECharts
  - 功能: 数据可视化
  - 优势: 功能强大，文档完善，中文支持好
  
- **UI框架**: Bootstrap 5 或 Element Plus
  - Bootstrap 5: 轻量，原生JavaScript兼容
  - Element Plus: Vue生态，组件丰富
  
- **日期处理**: Day.js
  - 功能: 日期计算和格式化
  - 优势: 轻量级，API友好

### 2.2 系统架构图

```
┌─────────────────────────────────────────────────────────┐
│                     浏览器环境                            │
│                                                         │
│  ┌───────────────────────────────────────────────────┐  │
│  │              用户界面层 (UI Layer)                  │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐           │  │
│  │  │文件上传 │  │数据预览 │  │图表展示 │           │  │
│  │  └─────────┘  └─────────┘  └─────────┘           │  │
│  └───────────────────────────────────────────────────┘  │
│                         ↓                               │
│  ┌───────────────────────────────────────────────────┐  │
│  │           业务逻辑层 (Business Logic)              │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐           │  │
│  │  │数据验证 │  │数据转换 │  │图表生成 │           │  │
│  │  └─────────┘  └─────────┘  └─────────┘           │  │
│  └───────────────────────────────────────────────────┘  │
│                         ↓                               │
│  ┌───────────────────────────────────────────────────┐  │
│  │           数据处理层 (Data Processing)             │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐           │  │
│  │  │Excel解析│  │数据清洗 │  │数据导出 │           │  │
│  │  └─────────┘  └─────────┘  └─────────┘           │  │
│  └───────────────────────────────────────────────────┘  │
│                         ↓                               │
│  ┌───────────────────────────────────────────────────┐  │
│  │          工具库层 (Utility Libraries)              │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐           │  │
│  │  │SheetJS  │  │ECharts  │  │Day.js   │           │  │
│  │  └─────────┘  └─────────┘  └─────────┘           │  │
│  └───────────────────────────────────────────────────┘  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 2.3 模块设计

#### 2.3.1 文件上传模块 (FileUploader)
- 功能: 处理Excel文件选择和读取
- 输入: 用户选择的Excel文件
- 输出: 原始数据数组
- 关键API: FileReader API, SheetJS

#### 2.3.2 数据解析模块 (DataParser)
- 功能: 解析Excel数据结构
- 输入: SheetJS解析后的工作簿对象
- 输出: 结构化的JavaScript对象数组
- 职责:
  - 识别表头
  - 提取数据行
  - 类型转换

#### 2.3.3 数据转换模块 (DataTransformer)
- 功能: 复刻VBA脚本的数据处理逻辑
- 核心功能:
  - 删除"合计"行
  - 车间列分列（提取区域）
  - 维修人分类（维修工/电工/未知）
  - 时间计算（等待时间、维修时间、故障时间）
  - 删除时间不完整的行
- 输入: 原始数据数组
- 输出: 处理后的数据数组

#### 2.3.4 数据验证模块 (DataValidator)
- 功能: 验证数据完整性和正确性
- 验证项:
  - 必需列存在性检查
  - 数据类型验证
  - 日期格式验证
  - 数据范围检查

#### 2.3.5 图表生成模块 (ChartGenerator)
- 功能: 基于处理后的数据生成ECharts图表
- 支持的图表类型（预留）:
  - 故障时间趋势图
  - 车间故障统计
  - 维修人员工作量统计
  - 故障类型分析

#### 2.3.6 数据导出模块 (DataExporter)
- 功能: 导出处理后的数据
- 支持格式:
  - Excel (.xlsx)
  - CSV
  - JSON

## 3. 数据流设计

### 3.1 主要数据流

```
用户选择Excel文件
    ↓
FileUploader读取文件
    ↓
SheetJS解析Excel → 原始工作簿对象
    ↓
DataParser提取数据 → 原始数据数组
    ↓
DataValidator验证数据 → 验证报告
    ↓
DataTransformer转换数据 → 处理后数据数组
    ↓
┌───────────────┬───────────────┐
↓               ↓               ↓
数据预览      图表展示        数据导出
```

### 3.2 数据结构定义

#### 原始数据格式
```javascript
{
  workOrder: string,        // 工单号
  workshop: string,         // 车间
  area: string,            // 区域 (可能不存在)
  repairPerson: string,    // 维修人
  repairPersonType: string, // 维修人分类 (可能不存在)
  reportTime: Date,        // 报修时间
  startTime: Date,         // 维修开始时间
  endTime: Date,           // 维修结束时间
  // ... 其他字段
}
```

#### 处理后数据格式
```javascript
{
  workOrder: string,        // 工单号
  workshop: string,         // 车间 (已分列)
  area: string,            // 区域 (已提取)
  repairPerson: string,    // 维修人
  repairPersonType: string, // 维修人分类 (已分类)
  reportTime: Date,        // 报修时间
  startTime: Date,         // 维修开始时间
  endTime: Date,           // 维修结束时间
  waitTime: number,        // 等待时间(小时)
  repairTime: number,      // 维修时间(小时)
  faultTime: number,       // 故障时间(小时)
  // ... 其他字段
}
```

## 4. 部署架构

### 4.1 文件结构

```
Equipment-Fault-Statistics/
├── index.html                 # 主页面
├── css/
│   ├── main.css              # 主样式
│   └── components.css        # 组件样式
├── js/
│   ├── main.js               # 入口文件
│   ├── modules/
│   │   ├── fileUploader.js   # 文件上传模块
│   │   ├── dataParser.js     # 数据解析模块
│   │   ├── dataTransformer.js # 数据转换模块
│   │   ├── dataValidator.js  # 数据验证模块
│   │   ├── chartGenerator.js # 图表生成模块
│   │   └── dataExporter.js   # 数据导出模块
│   ├── config/
│   │   └── constants.js      # 常量配置
│   └── utils/
│       ├── dateUtils.js      # 日期工具
│       └── helpers.js        # 辅助函数
├── lib/
│   ├── xlsx.full.min.js      # SheetJS库
│   ├── echarts.min.js        # ECharts库
│   └── dayjs.min.js          # Day.js库
├── docs/
│   ├── ARCHITECTURE.md       # 本文档
│   ├── SPECIFICATION.md      # 技术规格说明
│   ├── IMPLEMENTATION.md     # 实现计划
│   └── DATA_STRUCTURE.md     # 数据结构文档
└── README.md                 # 项目说明
```

### 4.2 部署方式

#### 方式1: 本地直接运行
1. 下载项目文件夹
2. 双击打开 `index.html`
3. 在浏览器中运行

#### 方式2: 本地Web服务器
```bash
# Python 3
python -m http.server 8000

# Node.js
npx http-server
```

#### 方式3: 静态托管平台
- GitHub Pages
- Vercel
- Netlify
- 阿里云OSS静态网站

## 5. 性能考虑

### 5.1 大文件处理
- **问题**: Excel文件可能包含大量数据
- **解决方案**:
  - 使用Web Worker进行后台数据处理
  - 分页显示数据
  - 虚拟滚动技术

### 5.2 内存管理
- **问题**: 大数据集可能占用过多内存
- **解决方案**:
  - 及时释放不用的数据
  - 使用流式处理
  - 数据分块处理

### 5.3 渲染优化
- **问题**: 大量数据渲染可能卡顿
- **解决方案**:
  - 图表数据采样
  - 懒加载
  - 防抖和节流

## 6. 安全考虑

### 6.1 数据隐私
- 所有数据处理在本地完成
- 不向任何服务器发送数据
- 用户可离线使用

### 6.2 输入验证
- 验证文件类型
- 检查文件大小
- 防止XSS攻击（如果显示用户输入内容）

## 7. 浏览器兼容性

### 7.1 支持的浏览器
- Chrome/Edge 90+
- Firefox 88+
- Safari 14+

### 7.2 关键API要求
- FileReader API
- Web Worker (可选，用于性能优化)
- ES6+ 支持

## 8. 扩展性设计

### 8.1 插件化图表
- 预留图表配置接口
- 支持自定义图表类型
- 可配置的图表选项

### 8.2 数据处理规则扩展
- 可配置的转换规则
- 支持自定义验证器
- 规则链模式

### 8.3 多语言支持
- 国际化(i18n)接口
- 默认中文
- 可扩展其他语言

## 9. 后续迭代方向

1. **Phase 1**: 核心数据处理功能（当前）
2. **Phase 2**: 基础图表展示
3. **Phase 3**: 高级图表和分析功能
4. **Phase 4**: 数据对比和趋势分析
5. **Phase 5**: 报表模板和自定义配置

## 10. 技术风险与应对

### 10.1 浏览器兼容性问题
- **风险**: 不同浏览器API支持差异
- **应对**: 使用Polyfill，提供兼容性提示

### 10.2 性能问题
- **风险**: 大数据量处理缓慢
- **应对**: Web Worker，数据分片，性能监控

### 10.3 数据准确性
- **风险**: 转换逻辑与VBA不一致
- **应对**: 单元测试，对比测试，详细文档

## 11. 开发建议

### 11.1 开发顺序
1. 搭建基础项目结构
2. 实现Excel文件上传和解析
3. 实现数据转换核心逻辑
4. 实现数据预览功能
5. 实现数据导出功能
6. 实现图表展示（后期）
7. 优化和测试

### 11.2 测试策略
- 单元测试: 每个模块独立测试
- 集成测试: 数据流完整性测试
- 端到端测试: 用户操作流程测试
- 对比测试: 与VBA结果对比

### 11.3 代码规范
- 使用ESLint进行代码检查
- 统一代码风格（Prettier）
- 完善的注释文档
- 模块化设计，高内聚低耦合
